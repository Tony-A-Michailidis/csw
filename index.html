<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Institute XYZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-GtvYcIpu7L10Q3KJpLelvZL+8xwI6GZLYO2P9AqejyZm0v2yGvNEbbMPFZ7fGFFM"
    crossorigin="anonymous">
  <style>
    /* custom tweaks */
    .card { margin-top: 1rem; }
    .nav-tabs .nav-link { cursor: pointer; }
    #div-csw-results-glass {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>

  <div class="container">

    <!-- Header -->
    <h1 class="mt-4">Institute XYZ</h1>

    <!-- Search Card -->
    <div class="card p-4 position-relative">
      <div id="div-csw-results-glass" class="d-flex justify-content-center align-items-center">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading…</span></div>
      </div>

      <!-- Search Bar -->
      <div class="input-group mb-3">
        <input type="text" class="form-control" id="input-anytext" placeholder="Search Terms">
        <button class="btn btn-primary" id="btn-search">Search</button>
      </div>

      <!-- Tabs -->
      <ul class="nav nav-tabs mb-1" id="tab-services">
        <li class="nav-item">
          <a class="nav-link active" data-service="ECCC">Our institute's data</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-service="EDH">DFO's data (login to call the API)</a>
        </li>
      </ul>
      <hr>

      <!-- Results Count -->
      <div id="div-results" class="text-center mb-2"></div>

      <!-- ECCC Table -->
      <table class="table" id="table-csw-results-eccc">
        <thead>
          <tr>
            <th>Title</th>
            <th>Date</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- rows go here -->
        </tbody>
      </table>

      <!-- EDH Table -->
      <table class="table d-none" id="table-csw-results-edh">
        <thead>
          <tr>
            <th>Title</th>
            <th>Date</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- rows go here -->
        </tbody>
      </table>

      <!-- Pagination -->
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mb-0">
          <li class="page-item">
            <button class="page-link" id="btn-prev">Previous</button>
          </li>
          <li class="page-item">
            <button class="page-link" id="btn-next">Next</button>
          </li>
        </ul>
      </nav>

      <!-- Hidden inputs for paging -->
      <input type="hidden" id="input-startposition" value="1">
      <input type="hidden" id="input-nextrecord" value="1">
      <input type="hidden" id="input-matched" value="0">

    </div> <!-- /.card -->

  </div> <!-- /.container -->

  <!-- jQuery + Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
          integrity="sha384-66b2Up4C+woammLd0jxQ4P5VvAHZyuBSI35nH1JUMizxjqHnAjnqht3JEUHpYQo2"
          crossorigin="anonymous"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-R0ER7aKJcIUWavbud4qE7U+/SMo5LqxL3w1nE9QdXBo+JktztZkunO07ANb8P+g1"
    crossorigin="anonymous"></script>

  <script>
    // CSW endpoints
    const csw_url = {
      ECCC: 'https://catalogue.ec.gc.ca/geonetwork/srv/eng/csw',
      EDH:  'https://api-proxy-dev.edh-cde.unclass.dfo-mpo.gc.ca/data-sharing/external/eng/csw'
    };
    const pagesize = 10;
    let currentService = 'ECCC';

    // Utility to escape ns-prefixed tags
    function escapeElementName(name) {
      return name.replace(/:/g, '\\:');
    }

    // Perform CSW search
    function search(serviceType, startPosition = 1) {
      const urlBase = csw_url[serviceType];
      let url = `${urlBase}?service=CSW&version=2.0.2&request=GetRecords`
              + `&ElementSetName=full&typeNames=csw:Record`
              + `&maxRecords=${pagesize}&startPosition=${startPosition}`;

      const freetext = $('#input-anytext').val().trim();
      if (freetext) {
        url += `&constraintLanguage=CQL_TEXT`
            + `&constraint=csw:AnyText LIKE '%${encodeURIComponent(freetext)}%'`;
      }

      // show loading overlay
      $('#div-csw-results-glass').show();

      // target the correct tbody
      const tbodySelector = serviceType === 'ECCC'
        ? '#table-csw-results-eccc tbody'
        : '#table-csw-results-edh tbody';

      // clear previous rows
      $(tbodySelector).empty();

      // AJAX options
      let ajaxOpts = { url, dataType: 'xml' };
      if (serviceType === 'EDH') {
        ajaxOpts.crossDomain = true;
        ajaxOpts.xhrFields = { withCredentials: true };
      }

      $.ajax(ajaxOpts)
        .done(xml => {
          // hide loading
          $('#div-csw-results-glass').hide();

          // parse out both full and brief records
          const records = $(
            escapeElementName('csw:Record') + ',' +
            escapeElementName('csw:BriefRecord'),
            xml
          );

          const totalMatched = parseInt(
            $(escapeElementName('csw:SearchResults'), xml)
              .attr('numberOfRecordsMatched') || 0,
            10
          );

          $('#input-startposition').val(startPosition);
          $('#input-matched').val(totalMatched);

          // compute next record pointer
          const nextRec = Math.min(startPosition + pagesize, totalMatched);
          $('#input-nextrecord').val(nextRec);

          // update count text
          $('#div-results').text(
            `Results ${startPosition} to ${nextRec} of ${totalMatched}`
          );

          // populate table or show "No results"
          if (records.length === 0) {
            $(tbodySelector).html(
              '<tr><td colspan="3" class="text-center">No results</td></tr>'
            );
          } else {
            records.each(function() {
              const rec = new CswRecord($(this));
              $(tbodySelector).append(style_record(rec));
            });
          }

          // toggle pagination buttons
          $('#btn-prev').prop('disabled', startPosition <= 1);
          $('#btn-next').prop('disabled', nextRec >= totalMatched);
        })
        .fail(() => {
          $('#div-csw-results-glass').hide();
          alert(`Failed to fetch records from ${serviceType}`);
        });
    }

    // Tab click handler
    $('#tab-services .nav-link').on('click', function() {
      $('#tab-services .nav-link').removeClass('active');
      $(this).addClass('active');
      currentService = $(this).data('service');

      // show/hide tables
      $('#table-csw-results-eccc, #table-csw-results-edh').addClass('d-none');
      $(`#table-csw-results-${currentService.toLowerCase()}`)
        .removeClass('d-none');

      // reset paging
      $('#input-startposition').val(1);
      $('#div-results').empty();
      $('#table-csw-results-eccc tbody, #table-csw-results-edh tbody').empty();
    });

    // Search button
    $('#btn-search').on('click', () => {
      search(currentService, 1);
    });

    // Pagination
    $('#btn-prev').on('click', () => {
      const start = parseInt($('#input-startposition').val(), 10);
      search(currentService, Math.max(1, start - pagesize));
    });
    $('#btn-next').on('click', () => {
      const next = parseInt($('#input-nextrecord').val(), 10);
      search(currentService, next);
    });

    // Example CswRecord constructor & style_record function…
    // (reuse your existing implementations here)
    function CswRecord($xml) { /* … */ }
    function style_record(rec) { /* … */ return rec.toRow(); }
  </script>
</body>
</html>
